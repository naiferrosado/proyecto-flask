{% extends "base.html" %}
{% block title %}Gestión de Usuarios - Rentflow{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- TÍTULO + VOLVER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary mb-0">
      <i class="bi bi-people me-2"></i> Gestión de Usuarios
    </h2>

    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary btn-sm">
      <i class="fa-solid fa-gauge me-1"></i> Volver al Dashboard
    </a>
  </div>

  <!-- MENSAJES FLASH -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ESTADÍSTICAS -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold">Total de Usuarios</h5>
          <p class="display-6 text-primary">{{ usuarios.total }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold">Administradores</h5>
          <p class="display-6 text-danger">
            {{ usuarios.items | selectattr('id_rol', 'equalto', 1) | list | length }}
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold">Usuarios Activos</h5>
          <p class="display-6 text-success">
            {{ usuarios.items | length }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-bold">
      <i class="bi bi-funnel me-2"></i> Filtros
    </div>

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" id="searchInput" class="form-control"
                 placeholder="Buscar por nombre, email...">
        </div>

        <div class="col-md-3">
          <select id="roleFilter" class="form-select">
            <option value="">Todos los roles</option>
            <option value="1">Administradores</option>
            <option value="2">Usuarios</option>
          </select>
        </div>

        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">Todos los estados</option>
            <option value="activo">Activos</option>
            <option value="suspendido">Suspendidos</option>
          </select>
        </div>

        <div class="col-md-2">
          <button class="btn btn-success w-100" onclick="filtrarUsuarios()">
            <i class="bi bi-search me-1"></i> Filtrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA DE USUARIOS -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white fw-bold">
      <i class="fa-solid fa-users me-2"></i> Lista de Usuarios
    </div>

    <div class="card-body table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Contacto</th>
            <th>Rol</th>
            <th>Registro</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>

        <tbody>
          {% for usuario in usuarios.items %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <img src="https://ui-avatars.com/api/?name={{ usuario.nombre }}+{{ usuario.apellido }}&background=0D6EFD&color=fff&rounded=true&size=45"
                     class="rounded-circle me-3">
                <div>
                  <strong>{{ usuario.nombre }} {{ usuario.apellido }}</strong><br>
                  <small class="text-muted">ID: {{ usuario.id_usuario }}</small>
                </div>
              </div>
            </td>

            <td>
              <small>{{ usuario.correo }}</small><br>
              <small class="text-muted">{{ usuario.telefono }}</small>
            </td>

            <td>
              <span class="badge bg-{{ 'danger' if usuario.id_rol == 1 else 'primary' }}">
                {{ "Administrador" if usuario.id_rol == 1 else "Usuario" }}
              </span>
            </td>

            <td>
              <small>{{ usuario.fecha_registro.strftime('%d/%m/%Y') }}</small>
            </td>

            <td>
              <span class="badge bg-success">
                <i class="bi bi-check-circle"></i> Activo
              </span>
            </td>

            <td class="text-center">
              <a href="{{ url_for('admin.ver_usuario', id=usuario.id_usuario) }}"
                 class="btn btn-outline-primary btn-sm me-2">
                <i class="fa-solid fa-eye"></i> Ver
              </a>

              <a href="{{ url_for('admin.editar_usuario', id=usuario.id_usuario) }}"
                 class="btn btn-warning btn-sm me-2">
                <i class="fa-solid fa-pen-to-square"></i> Editar
              </a>

              {% if usuario.id_rol != 1 %}
              <button class="btn btn-danger btn-sm"
                      onclick="eliminarUsuario({{ usuario.id_usuario }})">
                <i class="fa-solid fa-trash-can"></i> Eliminar
              </button>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- PAGINACIÓN -->
  {% if usuarios.pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if usuarios.has_prev %}
      <li class="page-item"><a class="page-link" href="{{ url_for('admin.usuarios', page=usuarios.prev_num) }}">Anterior</a></li>
      {% endif %}

      {% for page_num in usuarios.iter_pages() %}
        {% if page_num %}
        <li class="page-item {% if page_num == usuarios.page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('admin.usuarios', page=page_num) }}">{{ page_num }}</a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}
      {% endfor %}

      {% if usuarios.has_next %}
      <li class="page-item"><a class="page-link" href="{{ url_for('admin.usuarios', page=usuarios.next_num) }}">Siguiente</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>

<!-- MODAL ELIMINAR -->
<div class="modal fade" id="eliminarModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title fw-bold">Eliminar Usuario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar este usuario?</p>
        <p class="text-muted small">Esta acción es permanente.</p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>

        <form method="POST" action="" id="eliminarForm">
          <button type="submit" class="btn btn-danger">Eliminar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function filtrarUsuarios() {
    const search = document.getElementById("searchInput").value;
    const role = document.getElementById("roleFilter").value;
    const status = document.getElementById("statusFilter").value;

    let params = new URLSearchParams();
    if (search) params.append("search", search);
    if (role) params.append("rol", role);
    if (status) params.append("estado", status);

    window.location.href = window.location.pathname + "?" + params.toString();
  }

  function eliminarUsuario(id) {
    const modal = new bootstrap.Modal(document.getElementById("eliminarModal"));
    const form = document.getElementById("eliminarForm");

    form.action = "{{ url_for('admin.eliminar_usuario', id=0) }}".replace("0", id);
    modal.show();
  }
</script>

{% endblock %}
{% extends "base.html" %}
{% block title %}Gestión de Usuarios - Rentflow{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- TÍTULO + VOLVER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary mb-0">
      <i class="bi bi-people me-2"></i> Gestión de Usuarios
    </h2>

    <a href="{{ url_for('admin.dashboard') }}" class="btn btn-primary btn-sm">
      <i class="fa-solid fa-gauge me-1"></i> Volver al Dashboard
    </a>
  </div>

  <!-- MENSAJES FLASH -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show"
    role="alert">
    {{ message }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <!-- ESTADÍSTICAS -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold">Total de Usuarios</h5>
          <p class="display-6 text-primary">{{ usuarios.total }}</p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold">Administradores</h5>
          <p class="display-6 text-danger">
            {{ usuarios.items | selectattr('id_rol', 'equalto', 1) | list | length }}
          </p>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <h5 class="card-title fw-bold">Usuarios Activos</h5>
          <p class="display-6 text-success">
            {{ usuarios.items | selectattr('estado', 'equalto', 'activo') | list | length }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-bold">
      <i class="bi bi-funnel me-2"></i> Filtros
    </div>

    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-4">
          <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nombre, email...">
        </div>

        <div class="col-md-3">
          <select id="roleFilter" class="form-select">
            <option value="">Todos los roles</option>
            <option value="1">Administradores</option>
            <option value="2">Clientes</option>
            <option value="3">Propietarios</option>
          </select>
        </div>

        <div class="col-md-3">
          <select id="statusFilter" class="form-select">
            <option value="">Todos los estados</option>
            <option value="activo">Activos</option>
            <option value="suspendido">Suspendidos</option>
          </select>
        </div>

        <div class="col-md-2">
          <button class="btn btn-success w-100" onclick="filtrarUsuarios()">
            <i class="bi bi-search me-1"></i> Filtrar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- TABLA DE USUARIOS -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white fw-bold">
      <i class="fa-solid fa-users me-2"></i> Lista de Usuarios
    </div>

    <div class="card-body table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Contacto</th>
            <th>Rol</th>
            <th>Registro</th>
            <th>Estado</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>

        <tbody>
          {% for usuario in usuarios.items %}
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <img
                  src="https://ui-avatars.com/api/?name={{ usuario.nombre }}+{{ usuario.apellido }}&background=0D6EFD&color=fff&rounded=true&size=45"
                  class="rounded-circle me-3">
                <div>
                  <strong>{{ usuario.nombre }} {{ usuario.apellido }}</strong><br>
                  <small class="text-muted">ID: {{ usuario.id_usuario }}</small>
                </div>
              </div>
            </td>

            <td>
              <small>{{ usuario.correo }}</small><br>
              <small class="text-muted">{{ usuario.telefono }}</small>
            </td>

            <td>
              <span
                class="badge bg-{{ 'danger' if usuario.id_rol == 1 else 'primary' if usuario.id_rol == 2 else 'info' }}">
                {% if usuario.id_rol == 1 %}
                Administrador
                {% elif usuario.id_rol == 2 %}
                Cliente
                {% elif usuario.id_rol == 3 %}
                Propietario
                {% else %}
                Desconocido
                {% endif %}
              </span>
            </td>

            <td>
              <small>{{ usuario.fecha_registro.strftime('%d/%m/%Y') }}</small>
            </td>

            <td>
              {% if usuario.estado == 'activo' %}
              <span class="badge bg-success">
                <i class="bi bi-check-circle"></i> Activo
              </span>
              {% else %}
              <span class="badge bg-danger">
                <i class="bi bi-x-circle"></i> Suspendido
              </span>
              {% endif %}
            </td>


            <td class="text-center">

                <!-- VER (siempre disponible) -->
                <a href="{{ url_for('admin.ver_usuario', id=usuario.id_usuario) }}"
                  class="btn btn-outline-primary btn-sm me-2">
                    <i class="fa-solid fa-eye"></i> Ver
                </a>

                {% if usuario.id_usuario != current_user.id_usuario %}

                    <!-- EDITAR (no se edita a sí mismo) -->
                    <a href="{{ url_for('admin.editar_usuario', id=usuario.id_usuario) }}"
                      class="btn btn-warning btn-sm me-2">
                        <i class="fa-solid fa-pen-to-square"></i> Editar
                    </a>

                    <!-- ACCIONES: suspender / activar / eliminar -->
                    {% if usuario.id_rol != 1 %}  <!-- No permitir acciones sobre ADMIN -->

                        {% if usuario.estado == 'activo' %}
                            <!-- BOTÓN SUSPENDER -->
                            <button class="btn btn-danger btn-sm"
                                    onclick="suspenderUsuario({{ usuario.id_usuario }})">
                                <i class="fa-solid fa-ban"></i> Suspender
                            </button>

                        {% elif usuario.estado == 'suspendido' %}
                            <!-- BOTÓN ACTIVAR -->
                            <button class="btn btn-success btn-sm"
                                    onclick="activarUsuario({{ usuario.id_usuario }})">
                                <i class="fa-solid fa-check-circle"></i> Activar
                            </button>

                            <!-- BOTÓN ELIMINAR (solo suspendidos) -->
                            <button class="btn btn-dark btn-sm"
                                    onclick="eliminarUsuario({{ usuario.id_usuario }})">
                                <i class="fa-solid fa-trash-can"></i> Eliminar
                            </button>

                        {% endif %}

                    {% endif %}

                {% endif %}

            </td>


          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- PAGINACIÓN -->
  {% if usuarios.pages > 1 %}
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if usuarios.has_prev %}
      <li class="page-item"><a class="page-link"
          href="{{ url_for('admin.usuarios', page=usuarios.prev_num) }}">Anterior</a></li>
      {% endif %}

      {% for page_num in usuarios.iter_pages() %}
      {% if page_num %}
      <li class="page-item {% if page_num == usuarios.page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('admin.usuarios', page=page_num) }}">{{ page_num }}</a>
      </li>
      {% else %}
      <li class="page-item disabled"><span class="page-link">...</span></li>
      {% endif %}
      {% endfor %}

      {% if usuarios.has_next %}
      <li class="page-item"><a class="page-link"
          href="{{ url_for('admin.usuarios', page=usuarios.next_num) }}">Siguiente</a></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  // SUSPENDER USUARIO
 function suspenderUsuario(id) {
  Swal.fire({
    title: "¿Suspender usuario?",
    text: "El usuario no podrá acceder a la plataforma.",
    icon: "warning",
    showCancelButton: true,
    confirmButtonText: "Sí, suspender",
    cancelButtonText: "Cancelar"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/usuarios/suspender/${id}`, { method: "POST" })
        .then(r => r.json())
        .then(data => {
          Swal.fire(data.msg, "", data.ok ? "success" : "error").then(() => {
            if (data.ok) location.reload();
          });
        });
    }
  });
}

// ACTIVAR USUARIO
function activarUsuario(id) {
  Swal.fire({
    title: "¿Activar usuario?",
    text: "El usuario podrá acceder nuevamente.",
    icon: "info",
    showCancelButton: true,
    confirmButtonText: "Sí, activar",
    cancelButtonText: "Cancelar"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/usuarios/activar/${id}`, { method: "POST" })
        .then(r => r.json())
        .then(data => {
          Swal.fire(data.msg, "", data.ok ? "success" : "error").then(() => {
            if (data.ok) location.reload();
          });
        });
    }
  });
}

// ELIMINAR USUARIO
function eliminarUsuario(id) {
  Swal.fire({
    title: "¿Eliminar usuario?",
    text: "Esta acción es irreversible.",
    icon: "error",
    showCancelButton: true,
    confirmButtonText: "Sí, eliminar",
    cancelButtonText: "Cancelar"
  }).then((result) => {
    if (result.isConfirmed) {
      fetch(`/admin/usuarios/eliminar/${id}`, { method: "POST" })
        .then(r => r.json().catch(() => ({}))) // para manejar errores HTTP
        .then(data => {
          if (!data.ok) {
            Swal.fire(data.msg || "El usuario tiene una o mas reservas activas.", "", "error");
          } else {
            Swal.fire(data.msg, "", "success").then(() => location.reload());
          }
        })
        .catch(() => {
          Swal.fire("Error al conectar con el servidor.", "", "error");
        });
    }
  });
}

</script>


<script>
  function filtrarUsuarios() {
    const search = document.getElementById("searchInput").value;
    const role = document.getElementById("roleFilter").value;
    const status = document.getElementById("statusFilter").value;

    let params = new URLSearchParams();
    if (search) params.append("search", search);
    if (role) params.append("rol", role);
    if (status) params.append("estado", status);

    window.location.href = window.location.pathname + "?" + params.toString();
  }
</script>


{% endblock %}
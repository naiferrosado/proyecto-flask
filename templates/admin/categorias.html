{% extends "base.html" %} {% block title %}Gestión de Categorías - Rentflow{%
endblock %} {% block content %}
<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2"><i class="bi bi-tags"></i> Gestión de Categorías</h1>
    <button
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#crearCategoriaModal"
    >
      <i class="bi bi-plus-circle"></i> Nueva Categoría
    </button>
  </div>

  <!-- Estadísticas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body text-center">
          <h4 class="mb-1">{{ categorias|length }}</h4>
          <small>Total Categorías</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body text-center">
          <h4 class="mb-1">{{ total_objetos }}</h4>
          <small>Total Objetos</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body text-center">
          <h4 class="mb-1">
            {{ categoria_mas_popular.nombre if categoria_mas_popular else 'N/A'
            }}
          </h4>
          <small>Categoría Más Popular</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body text-center">
          <h4 class="mb-1">{{ categorias_sin_objetos }}</h4>
          <small>Categorías Vacías</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista de Categorías -->
  <div class="row">
    {% for categoria in categorias %}
    <div class="col-md-6 col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h5 class="card-title">{{ categoria.nombre }}</h5>
            <span class="badge bg-primary"
              >{{ categoria.objetos|length }} objetos</span
            >
          </div>
          <p class="card-text text-muted">
            {{ categoria.descripcion or 'Sin descripción' }}
          </p>
          <div class="mt-auto">
            <small class="text-muted">
              <i class="bi bi-calendar"></i>
              Creada el {{ categoria.fecha_creacion.strftime('%d/%m/%Y') if
              categoria.fecha_creacion else 'N/A' }}
            </small>
          </div>
        </div>
        <div class="card-footer bg-white">
          <div class="btn-group w-100">
            <button
              class="btn btn-outline-primary btn-sm"
              data-bs-toggle="modal"
              data-bs-target="#editarCategoriaModal"
              data-categoria-id="{{ categoria.id_categoria }}"
              data-categoria-nombre="{{ categoria.nombre }}"
              data-categoria-descripcion="{{ categoria.descripcion or '' }}"
            >
              <i class="bi bi-pencil"></i> Editar
            </button>
            {% if categoria.objetos|length == 0 %}
            <button
              class="btn btn-outline-danger btn-sm"
              onclick="eliminarCategoria({{ categoria.id_categoria }}, '{{ categoria.nombre }}')"
            >
              <i class="bi bi-trash"></i> Eliminar
            </button>
            {% else %}
            <button
              class="btn btn-outline-secondary btn-sm"
              disabled
              title="No se puede eliminar categoría con objetos"
            >
              <i class="bi bi-trash"></i> Eliminar
            </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Estado vacío -->
  {% if not categorias %}
  <div class="text-center py-5">
    <i class="bi bi-tags display-1 text-muted"></i>
    <h3 class="text-muted mt-3">No hay categorías</h3>
    <p class="text-muted">
      Crea la primera categoría para organizar los objetos
    </p>
    <button
      class="btn btn-primary mt-3"
      data-bs-toggle="modal"
      data-bs-target="#crearCategoriaModal"
    >
      <i class="bi bi-plus-circle"></i> Crear Primera Categoría
    </button>
  </div>
  {% endif %}
</div>

<!-- Modal para crear categoría -->
<div class="modal fade" id="crearCategoriaModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('admin.crear_categoria') }}">
        <div class="modal-header">
          <h5 class="modal-title">Crear Nueva Categoría</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre de la categoría</label>
            <input
              type="text"
              class="form-control"
              name="nombre"
              required
              placeholder="Ej: Herramientas, Electrodomésticos..."
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea
              class="form-control"
              name="descripcion"
              rows="3"
              placeholder="Descripción opcional de la categoría..."
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Crear Categoría</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal para editar categoría -->
<div class="modal fade" id="editarCategoriaModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('admin.editar_categoria') }}">
        <input type="hidden" name="categoria_id" id="editarCategoriaId" />
        <div class="modal-header">
          <h5 class="modal-title">Editar Categoría</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Nombre de la categoría</label>
            <input
              type="text"
              class="form-control"
              name="nombre"
              id="editarCategoriaNombre"
              required
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea
              class="form-control"
              name="descripcion"
              id="editarCategoriaDescripcion"
              rows="3"
            ></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Configurar modal de edición
  document.addEventListener("DOMContentLoaded", function () {
    const editarModal = document.getElementById("editarCategoriaModal");
    editarModal.addEventListener("show.bs.modal", function (event) {
      const button = event.relatedTarget;
      const categoriaId = button.getAttribute("data-categoria-id");
      const categoriaNombre = button.getAttribute("data-categoria-nombre");
      const categoriaDescripcion = button.getAttribute(
        "data-categoria-descripcion"
      );

      document.getElementById("editarCategoriaId").value = categoriaId;
      document.getElementById("editarCategoriaNombre").value = categoriaNombre;
      document.getElementById("editarCategoriaDescripcion").value =
        categoriaDescripcion;
    });
  });

  function eliminarCategoria(id, nombre) {
    if (
      confirm(`¿Estás seguro de que quieres eliminar la categoría "${nombre}"?`)
    ) {
      // Aquí iría la llamada AJAX para eliminar la categoría
      console.log("Eliminando categoría:", id);
      alert("Categoría eliminada correctamente");
      // Recargar la página o actualizar la lista
      location.reload();
    }
  }
</script>
{% endblock %}

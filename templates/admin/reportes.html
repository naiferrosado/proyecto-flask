{% extends "base.html" %}
{% block title %}Reportes y Estadísticas - Rentflow{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  <!-- ENCABEZADO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary mb-0">
      <i class="bi bi-graph-up-arrow me-2"></i> Reportes y Estadísticas
    </h2>

    <div>
      <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary me-2">
        <i class="bi bi-arrow-left"></i> Volver
      </a>

      <div class="btn-group">
        <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-download"></i> Exportar Reporte
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{{ url_for('admin.exportar_reporte', formato='pdf') }}">PDF</a></li>
          <li><a class="dropdown-item" href="{{ url_for('admin.exportar_reporte', formato='excel') }}">Excel</a></li>
          <li><a class="dropdown-item" href="{{ url_for('admin.exportar_reporte', formato='csv') }}">CSV</a></li>
        </ul>
      </div>
    </div>
  </div>

  <!-- FILTROS -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white fw-bold">
      <i class="bi bi-funnel"></i> Filtros del Reporte
    </div>

    <div class="card-body">
      <div class="row g-3 align-items-end">

        <div class="col-md-3">
          <label class="form-label fw-semibold">Fecha desde</label>
          <input type="date" id="fechaDesde" class="form-control" value="{{ fecha_inicio }}">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Fecha hasta</label>
          <input type="date" id="fechaHasta" class="form-control" value="{{ fecha_fin }}">
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Tipo de reporte</label>
          <select id="tipoReporte" class="form-select">
            <option value="general">General</option>
            <option value="usuarios">Usuarios</option>
            <option value="transacciones">Transacciones</option>
            <option value="objetos">Objetos</option>
          </select>
        </div>

        <div class="col-md-3">
          <button class="btn btn-primary w-100" onclick="generarReporte(event)">
            <i class="bi bi-arrow-repeat me-1"></i> Generar Reporte
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- ESTADÍSTICAS PRINCIPALES -->
  <div class="row mb-4">

    {% set cards = [
      ('Ingresos Totales', estadisticas.ingresos_totales, 'currency-dollar', 'primary'),
      ('Reservas Completadas', estadisticas.reservas_completadas, 'calendar-check', 'success'),
      ('Nuevos Usuarios', estadisticas.nuevos_usuarios, 'person-plus', 'info'),
      ('Objetos Publicados', estadisticas.objetos_publicados, 'grid', 'warning')
    ] %}

    {% for titulo, valor, icono, color in cards %}
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card border-start border-{{ color }} border-4 shadow h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">

            <div>
              <div class="text-uppercase small fw-bold text-{{ color }}">
                {{ titulo }}
              </div>

              <div class="h4 fw-bold mt-1">
                {% if titulo == 'Ingresos Totales' %}
                  RD$ {{ "%.2f"|format(valor or 0) }}
                {% else %}
                  {{ valor or 0 }}
                {% endif %}
              </div>
            </div>

            <i class="bi bi-{{ icono }} text-secondary display-6 opacity-25"></i>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="row">

    <!-- GRÁFICOS -->
    <div class="col-lg-8">

      <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold">
          <i class="bi bi-bar-chart-line"></i> Actividad Mensual
        </div>
        <div class="card-body">
          <canvas id="chartActividad" height="120"></canvas>
        </div>
      </div>

      <div class="row">

        <div class="col-md-6">
          <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold">
              <i class="bi bi-pie-chart"></i> Distribución por Categoría
            </div>
            <div class="card-body">
              <canvas id="chartCategorias" height="150"></canvas>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card shadow-sm mb-4">
            <div class="card-header fw-bold">
              <i class="bi bi-geo-alt"></i> Distribución Geográfica
            </div>
            <div class="card-body">
              <canvas id="chartGeografico" height="150"></canvas>
            </div>
          </div>
        </div>

      </div>

    </div>

    <!-- INFO LATERAL -->
    <div class="col-lg-4">

      <!-- Top Propietarios -->
      <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold">
          <i class="bi bi-trophy"></i> Top Propietarios (Ingresos)
        </div>
        <div class="card-body">

          {% if top_propietarios %}
            {% for p in top_propietarios %}
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <strong>{{ p.nombre }}</strong><br>
                <small class="text-muted">
                  {{ p.total_reservas }} reservas
                </small>
              </div>

              <span class="badge bg-success">
                RD$ {{ "%.2f"|format(p.ingresos) }}
              </span>
            </div>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center">No hay datos disponibles.</p>
          {% endif %}

        </div>
      </div>

      <!-- Objetos Más Populares -->
      <div class="card shadow-sm mb-4">
        <div class="card-header fw-bold">
          <i class="bi bi-star"></i> Objetos Más Populares
        </div>

        <div class="card-body">
          {% if objetos_populares %}
           {% for obj in objetos_populares %}
          <div class="d-flex justify-content-between align-items-center mb-3">

            <div class="text-truncate" style="max-width: 150px;">
              <strong>{{ obj.nombre }}</strong><br>
              <small class="text-muted">{{ obj.reservas }} reservas</small>
            </div>

            <span class="badge bg-warning text-dark">
              ⭐ {{ obj.calificacion|round(1) }}
            </span>

          </div>
          {% endfor %}

          {% else %}
            <p class="text-muted text-center">No hay datos disponibles.</p>
          {% endif %}
        </div>
      </div>

      <!-- Tendencias -->
      <div class="card shadow-sm">
        <div class="card-header fw-bold">
          <i class="bi bi-graph-up"></i> Tendencias
        </div>
        <div class="card-body small">

          {% set t = tendencias or {} %}

          <p class="{{ 'text-success' if t.reservas >= 0 else 'text-danger' }}">
            <i class="bi {{ 'bi-arrow-up' if t.reservas >= 0 else 'bi-arrow-down' }}"></i>
            {{ t.reservas }}% crecimiento en reservas
          </p>

          <p class="{{ 'text-success' if t.usuarios >= 0 else 'text-danger' }}">
            <i class="bi {{ 'bi-arrow-up' if t.usuarios >= 0 else 'bi-arrow-down' }}"></i>
            {{ t.usuarios }}% nuevos usuarios
          </p>

          <p class="text-success">
            <i class="bi bi-arrow-up"></i>
            +{{ t.cat_positiva.porcentaje }}% {{ t.cat_positiva.nombre }}
          </p>

          <p class="text-danger">
            <i class="bi bi-arrow-down"></i>
            {{ t.cat_negativa.porcentaje }}% {{ t.cat_negativa.nombre }}
          </p>

        </div>
      </div>

    </div>
  </div>
</div>

<!-- LÓGICA DE FILTROS -->
<script>
function generarReporte(event) {
  const desde = fechaDesde.value;
  const hasta = fechaHasta.value;

  if (!desde || !hasta)
    return alert("Seleccione un rango de fechas.");

  if (desde > hasta)
    return alert("La fecha inicial no puede ser mayor que la final.");

  const tipo = tipoReporte.value;

  const btn = event.target;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generando...';

  setTimeout(() => {
    alert(`Reporte generado del ${desde} al ${hasta}.`);
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Generar Reporte';
  }, 1000);
}
</script>
{% endblock %}